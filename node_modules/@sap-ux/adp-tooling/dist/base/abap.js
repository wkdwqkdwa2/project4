"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getManifest = getManifest;
exports.getManifestDataSources = getManifestDataSources;
const system_access_1 = require("@sap-ux/system-access");
const axios_extension_1 = require("@sap-ux/axios-extension");
/**
 * Get the application manifest.
 *
 * @param {string} appId - The application id.
 * @param {AdpPreviewConfig} adpConfig - The ADP configuration.
 * @param {ToolsLogger} logger - The logger.
 * @returns {Promise<Manifest>} The manifest.
 */
async function getManifest(appId, adpConfig, logger) {
    const provider = await (0, system_access_1.createAbapServiceProvider)(adpConfig.target, {
        ignoreCertErrors: adpConfig.ignoreCertErrors ?? false
    }, true, logger);
    const appInfo = (await provider.getAppIndex().getAppInfo(appId))[appId];
    const manifestUrl = appInfo.manifestUrl ?? appInfo.manifest;
    if (!manifestUrl) {
        throw new Error('Manifest URL not found');
    }
    try {
        const response = await provider.get(manifestUrl);
        return JSON.parse(response.data);
    }
    catch (error) {
        if ((0, axios_extension_1.isAxiosError)(error)) {
            logger.error('Manifest fetching failed');
        }
        else {
            logger.error('Manifest parsing error: Manifest is not in expected format.');
        }
        logger.debug(error);
        throw error;
    }
}
/**
 * Returns the adaptation project configuration, throws an error if not found.
 *
 * @param {string} reference - The base application id.
 * @param {AdpPreviewConfig} adpConfig - The adaptation project configuration.
 * @param {ToolsLogger} logger - The logger.
 * @returns {Promise<DataSources>} data sources from base application manifest
 */
async function getManifestDataSources(reference, adpConfig, logger) {
    const manifest = await exports.getManifest(reference, adpConfig, logger);
    const dataSources = manifest['sap.app'].dataSources;
    if (!dataSources) {
        throw new Error('No data sources found in the manifest');
    }
    return dataSources;
}
//# sourceMappingURL=abap.js.map